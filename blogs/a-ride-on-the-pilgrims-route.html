---
layout:      page
title:       A Ride on The Pilgrims' Route
--- 

<section id='blog-pannel'>
  <h1>{{ page.title }}</h1>
  <ul>
  {% for category in site.categories %}
    {% if page.title == category[0] %}
      {% assign post_json = category[1] | map: 'path' | replace: '_posts/', '/data/a-ride-on-the-pilgrims-route/' | replace: '.md', '.geojson' %}
      {% for post in category[1] %}
      {% assign content = post.content | strip_newlines %}
      <li id='{{ post.path | slice: 18, 100 | remove: ".md" }}' {% if content == '' %} class='no_post_yet' {% endif %}>
        {% if content != '' %}<a href="{{ post.url }}"></a>{% endif %}
        <img src='{{ post.thumbnail }}'/>
        <p class='blog-index-post-date {% if post.date_bottom %} date_bottom {% endif %}'>{{ post.date | date: "%Y %b %-d" }}</p>
        <div>
          {% assign day = post.url | slice: 13, 3 %}
          <p class='blog-index-post-title'>{% if day !=  'pil' %} Day #{{ day }} {% endif %}{{ post.title }}</p>
          {% if content != '' %}<p>{{ content }}</p>{% endif %}
        </div>
      </li>
      {% endfor %}
    {% endif %}
  {% endfor %}
  </ul>
</section>
<section id='map-pannel'></section>

<script>
    
  // SETTING ---------------------------------------------------------------

  var map = L.map('map-pannel', {
    minZoom: 4,
    center: [55, 5],
    zoom: 4,
    zoomControl: false,
  })

  L.tileLayer(
    'http://server.arcgisonline.com/'+
    'ArcGIS/rest/services/World_Topo_Map/'+
    'MapServer/tile/{z}/{y}/{x}'
  ).addTo(map);

  var post_names;
  var associated_track_files = {{ post_json }};
  var associated_track = [];

  function get_post_name(file){
    return file
      .replace(/\.geojson$/i, '')
      .replace(/^\/data\/a-ride-on-the-pilgrims-route\/.{4}-.{2}-.{2}-/i, '');
  }
  post_names = associated_track_files.map(get_post_name);

  $('#close-button').click(function(){
    map.flyToBounds(itinerary.getBounds());
  });

  $.getJSON("/data/2016-05-21-ev3.geojson", function(data) {

    var the_pilgrims_route = new L.geoJson(data, {
      opacity: 0.6,
      weight:  3.5
    });
    the_pilgrims_route = the_pilgrims_route.getLayers()[0];
    
    var itinerary = jQuery.extend(true, {}, the_pilgrims_route);
    itinerary.addTo(map);
    $(map).on('reset', function(){
      map.flyToBounds(itinerary);
    })

    // add post tracks to the map
    function add_to_map(tracks){

      // for each defined track
      for(i=1; i<tracks.length; i++){
        var track = tracks[i];
        if(typeof track != 'undefined'){

          // 1. retreive the itinerary's departure and arrival
        
          var from = $.grep(track.features, function(f){
            return f.properties.stage === 'departure'
          });
          var to = $.grep(track.features, function(f){
            return f.properties.stage === 'arrival'
          });
          from = turf.point(from[0].geometry.coordinates);
          to   = turf.point(  to[0].geometry.coordinates);

          // 2. create an approximate track along the itinerary
          
          var overall_track   = the_pilgrims_route.toGeoJSON();
          associated_track[i] = turf.lineSlice(from, to, overall_track);
          associated_track[i] = L.geoJson(associated_track[i], {
            opacity:   1,
            weight:    5,
            color: '#ff6600'
          }).getLayers()[0];

          // 3. bind the appearance / disappearance of the track to the hovering of the corresponding post cartouche

          var post_name = post_names[i];
          console.log('#'+post_name);
          $('#'+post_name).hover(
            function(){
              var name  = $(this).attr('id');
              var index = post_names.indexOf(name);
              associated_track[index].addTo(map);
            },
            function(){
              var name  = $(this).attr('id');
              var index = post_names.indexOf(name);
              map.removeLayer(associated_track[index])
            }
          )
          
          // 4. bind the highlight of the object to the hover of the line

          // 5. bind the zoom event to the click on a list item
          
          $('#'+post_name).click(function(){
            var name  = $(this).attr('id');
            var index = post_names.indexOf(name);
            map.flyToBounds(associated_track[index].getBounds());
          })

        }
     }
    };

    function keep_reading(array, i){

      // keep calling the reading function
      if(i < post_names.length){
        $.getJSON(associated_track_files[i])
          .done(function(data){
            array[i] = data;
          })
          .always(function(){
            i++;
            return(keep_reading(array, i));
          })
      }else{
        // when finished reading all files,
        // call back add_to_map
        add_to_map(array);
      }
    }

    keep_reading([], 0);

  });

  var blogPannel;

  $("#blog-pannel a").click(function(e){

    // http://stackoverflow.com/questions/4002580/how-to-do-partial-page-update-with-jquery

    // prevent from going to the page and save content
    e.preventDefault();
    blogPannel = $("#blog-pannel").clone(true);

    // get the href
    var href       = $(this).attr("href") + ' #post > section > *';
    $("#blog-pannel").load(href, function(){

      // implement a close button
      $(this).prepend('<div id="close-button">Ã—</div>');
      $('#close-button').click(function(){
        $("#blog-pannel").remove();
        $("#a-ride-on-the-pilgrims-route").prepend(blogPannel);
        $(map).trigger('reset');
      });

    });

  });

</script>